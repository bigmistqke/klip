{
  "lexicon": 1,
  "id": "app.klip.project",
  "defs": {
    "main": {
      "type": "record",
      "description": "A Klip project containing groups, tracks, curves, and effect pipelines",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["title", "canvas", "groups", "tracks", "createdAt"],
        "properties": {
          "schemaVersion": {
            "type": "integer",
            "description": "Schema version for migration support",
            "default": 1
          },
          "title": {
            "type": "string",
            "maxLength": 256
          },
          "description": {
            "type": "string",
            "maxLength": 2048
          },
          "bpm": {
            "type": "number",
            "description": "Beats per minute for grid/sync features",
            "minimum": 20,
            "maximum": 400
          },
          "duration": {
            "type": "integer",
            "description": "Total project duration in milliseconds",
            "minimum": 0
          },
          "canvas": {
            "type": "ref",
            "ref": "#canvas"
          },
          "curves": {
            "type": "array",
            "items": { "type": "ref", "ref": "#curve" },
            "maxLength": 256,
            "description": "Reusable animation curves. Each curve has a unique id field; validators must reject duplicates. Runtime may convert to map for O(1) lookup."
          },
          "groups": {
            "type": "array",
            "items": { "type": "ref", "ref": "#group" },
            "maxLength": 64,
            "description": "Groups containing tracks with layout effects"
          },
          "tracks": {
            "type": "array",
            "items": { "type": "ref", "ref": "#track" },
            "maxLength": 32
          },
          "masterAudioPipeline": {
            "type": "array",
            "items": { "type": "ref", "ref": "#audioEffect" },
            "maxLength": 16,
            "description": "Master audio bus effects"
          },
          "masterVideoPipeline": {
            "type": "array",
            "items": { "type": "ref", "ref": "#visualEffect" },
            "maxLength": 16,
            "description": "Master video output effects"
          },
          "parent": {
            "type": "ref",
            "ref": "com.atproto.repo.strongRef",
            "description": "Source project if this is a remix"
          },
          "createdAt": {
            "type": "string",
            "format": "datetime"
          },
          "updatedAt": {
            "type": "string",
            "format": "datetime"
          }
        }
      }
    },

    "canvas": {
      "type": "object",
      "description": "Output canvas dimensions",
      "required": ["width", "height"],
      "properties": {
        "width": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4096
        },
        "height": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4096
        },
        "background": {
          "type": "string",
          "description": "Background color (hex) or 'transparent'",
          "maxLength": 32
        }
      }
    },

    "curve": {
      "type": "union",
      "description": "Animation curve definition",
      "refs": [
        "#curve.keyframe",
        "#curve.envelope",
        "#curve.lfo"
      ]
    },

    "curve.keyframe": {
      "type": "object",
      "description": "Explicit keyframe curve with bezier interpolation",
      "required": ["type", "id", "points"],
      "properties": {
        "type": { "type": "string", "const": "keyframe" },
        "id": {
          "type": "string",
          "description": "Unique identifier for this curve",
          "maxLength": 64
        },
        "points": {
          "type": "array",
          "items": { "type": "ref", "ref": "#keyframePoint" },
          "minLength": 1,
          "maxLength": 256
        }
      }
    },

    "keyframePoint": {
      "type": "object",
      "description": "A point in a keyframe curve",
      "required": ["t", "v"],
      "properties": {
        "t": {
          "type": "number",
          "description": "Time in milliseconds"
        },
        "v": {
          "type": "number",
          "description": "Value at this point"
        },
        "in": {
          "type": "array",
          "description": "Incoming bezier handle [x, y] relative to point",
          "items": { "type": "number" },
          "minLength": 2,
          "maxLength": 2
        },
        "out": {
          "type": "array",
          "description": "Outgoing bezier handle [x, y] relative to point",
          "items": { "type": "number" },
          "minLength": 2,
          "maxLength": 2
        }
      }
    },

    "curve.envelope": {
      "type": "object",
      "description": "ADSR envelope generator",
      "required": ["type", "id"],
      "properties": {
        "type": { "type": "string", "const": "envelope" },
        "id": {
          "type": "string",
          "maxLength": 64
        },
        "attack": {
          "type": "ref",
          "ref": "#envelopePhase",
          "description": "Attack phase: 0 to peak"
        },
        "decay": {
          "type": "ref",
          "ref": "#envelopePhase",
          "description": "Decay phase: peak to sustain"
        },
        "sustain": {
          "type": "number",
          "description": "Sustain level (0-1)",
          "minimum": 0,
          "maximum": 1,
          "default": 1
        },
        "release": {
          "type": "ref",
          "ref": "#envelopePhase",
          "description": "Release phase: sustain to 0"
        },
        "peak": {
          "type": "number",
          "description": "Peak value at end of attack",
          "default": 1
        }
      }
    },

    "envelopePhase": {
      "type": "object",
      "description": "A phase of an envelope with duration and curve",
      "required": ["duration"],
      "properties": {
        "duration": {
          "type": "number",
          "description": "Phase duration in milliseconds",
          "minimum": 0
        },
        "curve": {
          "type": "array",
          "description": "Bezier control points [x1, y1, x2, y2]",
          "items": { "type": "number" },
          "minLength": 4,
          "maxLength": 4
        }
      }
    },

    "curve.lfo": {
      "type": "object",
      "description": "Low-frequency oscillator. Must have either frequency (Hz) or sync (beat division).",
      "required": ["type", "id"],
      "properties": {
        "type": { "type": "string", "const": "lfo" },
        "id": {
          "type": "string",
          "maxLength": 64
        },
        "waveform": {
          "type": "string",
          "enum": ["sine", "triangle", "square", "sawtooth"],
          "default": "sine"
        },
        "frequency": {
          "type": "number",
          "description": "Oscillation frequency in Hz. Ignored if sync is set.",
          "minimum": 0.01,
          "maximum": 100
        },
        "sync": {
          "type": "string",
          "description": "Beat division synced to project BPM. Overrides frequency when set.",
          "enum": ["4/1", "2/1", "1/1", "1/2", "1/4", "1/8", "1/16", "1/32"]
        },
        "amplitude": {
          "type": "number",
          "description": "Oscillation amplitude (0-1)",
          "minimum": 0,
          "maximum": 1,
          "default": 1
        },
        "center": {
          "type": "number",
          "description": "Center value to oscillate around (0-1)",
          "minimum": 0,
          "maximum": 1,
          "default": 0.5
        },
        "phase": {
          "type": "number",
          "description": "Phase offset in degrees",
          "minimum": 0,
          "maximum": 360,
          "default": 0
        }
      }
    },

    "value": {
      "type": "union",
      "description": "A numeric value that can be static or animated",
      "refs": ["#staticValue", "#curveRef"]
    },

    "staticValue": {
      "type": "object",
      "description": "A static numeric value with optional constraints",
      "required": ["value"],
      "properties": {
        "value": {
          "type": "number"
        },
        "min": {
          "type": "number",
          "description": "Minimum allowed value",
          "default": 0
        },
        "max": {
          "type": "number",
          "description": "Maximum allowed value",
          "default": 1
        },
        "default": {
          "type": "number",
          "description": "Default value if not specified"
        }
      }
    },

    "curveRef": {
      "type": "object",
      "description": "Reference to a curve with output scaling",
      "required": ["curve"],
      "properties": {
        "curve": {
          "type": "string",
          "description": "ID of the curve to reference. Must match an id in project.curves array.",
          "maxLength": 64
        },
        "min": {
          "type": "number",
          "description": "Minimum output value (curve 0 maps to this)",
          "default": 0
        },
        "max": {
          "type": "number",
          "description": "Maximum output value (curve 1 maps to this)",
          "default": 1
        },
        "offset": {
          "type": "number",
          "description": "Time offset in milliseconds",
          "default": 0
        },
        "timeScale": {
          "type": "number",
          "description": "Time multiplier (2 = twice as fast)",
          "default": 1
        },
        "timeRef": {
          "type": "string",
          "enum": ["clip", "project"],
          "description": "Time reference: clip-relative or project-relative",
          "default": "clip"
        }
      }
    },

    "booleanValue": {
      "type": "union",
      "description": "A boolean value that can be static or animated",
      "refs": ["#staticBooleanValue", "#booleanCurveRef"]
    },

    "staticBooleanValue": {
      "type": "object",
      "description": "A static boolean value",
      "required": ["value"],
      "properties": {
        "value": {
          "type": "boolean"
        }
      }
    },

    "booleanCurveRef": {
      "type": "object",
      "description": "Reference to a curve interpreted as boolean",
      "required": ["curve"],
      "properties": {
        "curve": {
          "type": "string",
          "description": "ID of the curve to reference. Must match an id in project.curves array.",
          "maxLength": 64
        },
        "threshold": {
          "type": "number",
          "description": "Value at which curve becomes true",
          "default": 0.5
        },
        "offset": {
          "type": "number",
          "description": "Time offset in milliseconds",
          "default": 0
        },
        "timeScale": {
          "type": "number",
          "description": "Time multiplier (2 = twice as fast)",
          "default": 1
        },
        "timeRef": {
          "type": "string",
          "enum": ["clip", "project"],
          "description": "Time reference: clip-relative or project-relative",
          "default": "clip"
        }
      }
    },

    "integerValue": {
      "type": "union",
      "description": "An integer value that can be static or animated",
      "refs": ["#staticIntegerValue", "#integerCurveRef"]
    },

    "staticIntegerValue": {
      "type": "object",
      "description": "A static integer value",
      "required": ["value"],
      "properties": {
        "value": {
          "type": "integer"
        },
        "min": {
          "type": "integer",
          "description": "Minimum allowed value"
        },
        "max": {
          "type": "integer",
          "description": "Maximum allowed value"
        }
      }
    },

    "integerCurveRef": {
      "type": "object",
      "description": "Reference to a curve with integer output",
      "required": ["curve"],
      "properties": {
        "curve": {
          "type": "string",
          "description": "ID of the curve to reference. Must match an id in project.curves array.",
          "maxLength": 64
        },
        "min": {
          "type": "integer",
          "description": "Minimum output value (curve 0 maps to this)",
          "default": 0
        },
        "max": {
          "type": "integer",
          "description": "Maximum output value (curve 1 maps to this)",
          "default": 1
        },
        "round": {
          "type": "string",
          "description": "Rounding method for interpolated values",
          "enum": ["floor", "round", "ceil"],
          "default": "round"
        },
        "offset": {
          "type": "number",
          "description": "Time offset in milliseconds",
          "default": 0
        },
        "timeScale": {
          "type": "number",
          "description": "Time multiplier (2 = twice as fast)",
          "default": 1
        },
        "timeRef": {
          "type": "string",
          "enum": ["clip", "project"],
          "description": "Time reference: clip-relative or project-relative",
          "default": "clip"
        }
      }
    },

    "group": {
      "type": "object",
      "description": "A group of tracks/groups with layout and visual effects",
      "required": ["id", "members"],
      "properties": {
        "id": {
          "type": "string",
          "maxLength": 64
        },
        "name": {
          "type": "string",
          "maxLength": 128
        },
        "members": {
          "type": "array",
          "items": { "type": "ref", "ref": "#groupMember" },
          "maxLength": 32,
          "description": "Tracks or nested groups in this group"
        },
        "layout": {
          "type": "ref",
          "ref": "#layout",
          "description": "How members are positioned within this group"
        },
        "pipeline": {
          "type": "array",
          "items": { "type": "ref", "ref": "#visualEffect" },
          "maxLength": 16,
          "description": "Visual effects applied to the composited group"
        }
      }
    },

    "groupMember": {
      "type": "object",
      "description": "A member of a group with optional position hints. Validators must ensure referenced id exists in project.tracks (if isGroup=false) or project.groups (if isGroup=true).",
      "required": ["id"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Track ID or group ID. Must match an existing track.id or group.id in the project.",
          "maxLength": 64
        },
        "isGroup": {
          "type": "boolean",
          "description": "True if this references a group, false/omitted for track",
          "default": false
        },
        "column": {
          "type": "integer",
          "description": "Grid column (1-based), used by grid layout",
          "minimum": 1
        },
        "row": {
          "type": "integer",
          "description": "Grid row (1-based), used by grid layout",
          "minimum": 1
        },
        "columnSpan": {
          "type": "integer",
          "minimum": 1,
          "default": 1
        },
        "rowSpan": {
          "type": "integer",
          "minimum": 1,
          "default": 1
        },
        "x": {
          "type": "ref",
          "ref": "#value",
          "description": "X position (0-1), used by absolute layout"
        },
        "y": {
          "type": "ref",
          "ref": "#value",
          "description": "Y position (0-1), used by absolute layout"
        },
        "width": {
          "type": "ref",
          "ref": "#value",
          "description": "Width (0-1), used by absolute layout"
        },
        "height": {
          "type": "ref",
          "ref": "#value",
          "description": "Height (0-1), used by absolute layout"
        },
        "zIndex": {
          "type": "ref",
          "ref": "#integerValue",
          "description": "Layer order within group"
        },
        "fit": {
          "type": "string",
          "enum": ["contain", "cover", "fill"],
          "default": "cover"
        }
      }
    },

    "track": {
      "type": "object",
      "description": "A track containing media clips and effect pipelines",
      "required": ["id", "clips"],
      "properties": {
        "id": {
          "type": "string",
          "maxLength": 64
        },
        "name": {
          "type": "string",
          "maxLength": 128
        },
        "stem": {
          "type": "ref",
          "ref": "com.atproto.repo.strongRef",
          "description": "Reference to app.klip.stem record"
        },
        "clips": {
          "type": "array",
          "items": { "type": "ref", "ref": "#clip" },
          "maxLength": 256
        },
        "audioPipeline": {
          "type": "array",
          "items": { "type": "ref", "ref": "#audioEffect" },
          "maxLength": 16,
          "description": "Track-level audio effect chain"
        },
        "videoPipeline": {
          "type": "array",
          "items": { "type": "ref", "ref": "#visualEffect" },
          "maxLength": 16,
          "description": "Track-level video effect chain"
        },
        "muted": {
          "type": "ref",
          "ref": "#booleanValue",
          "description": "Mute track"
        },
        "solo": {
          "type": "ref",
          "ref": "#booleanValue",
          "description": "Solo track"
        }
      }
    },

    "clip": {
      "type": "object",
      "description": "A region on the timeline referencing part of a stem",
      "required": ["id", "offset", "duration"],
      "properties": {
        "id": {
          "type": "string",
          "maxLength": 64
        },
        "offset": {
          "type": "integer",
          "description": "Position on timeline in milliseconds",
          "minimum": 0
        },
        "sourceOffset": {
          "type": "integer",
          "description": "Start position within source stem (for trimming)",
          "minimum": 0,
          "default": 0
        },
        "duration": {
          "type": "integer",
          "description": "Duration in milliseconds",
          "minimum": 0
        },
        "speed": {
          "type": "ref",
          "ref": "#value",
          "description": "Playback speed multiplier (0.1-10)"
        },
        "reverse": {
          "type": "ref",
          "ref": "#booleanValue",
          "description": "Play clip in reverse"
        },
        "audioPipeline": {
          "type": "array",
          "items": { "type": "ref", "ref": "#audioEffect" },
          "maxLength": 16,
          "description": "Clip-level audio effects (curves are clip-relative)"
        },
        "videoPipeline": {
          "type": "array",
          "items": { "type": "ref", "ref": "#visualEffect" },
          "maxLength": 16,
          "description": "Clip-level video effects (curves are clip-relative)"
        }
      }
    },

    "audioEffect": {
      "type": "union",
      "description": "Audio processing effect",
      "refs": [
        "#audioEffect.gain",
        "#audioEffect.pan",
        "#audioEffect.custom"
      ]
    },

    "audioEffect.gain": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": { "type": "string", "const": "audio.gain" },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "value": {
          "type": "ref",
          "ref": "#value",
          "description": "Volume (0-1, where 1 = unity gain)"
        }
      }
    },

    "audioEffect.pan": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": { "type": "string", "const": "audio.pan" },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "value": {
          "type": "ref",
          "ref": "#value",
          "description": "Stereo position (0 = left, 0.5 = center, 1 = right)"
        }
      }
    },

    "audioEffect.custom": {
      "type": "object",
      "description": "Custom or third-party audio effect",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Custom effect identifier (e.g., 'audio.vendor.effectName')"
        },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "params": {
          "type": "object",
          "description": "Effect-specific parameters"
        }
      }
    },

    "visualEffect": {
      "type": "union",
      "description": "Visual processing effect (usable on clips, tracks, and groups)",
      "refs": [
        "#visualEffect.transform",
        "#visualEffect.opacity",
        "#visualEffect.custom"
      ]
    },

    "visualEffect.transform": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": { "type": "string", "const": "visual.transform" },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "x": {
          "type": "ref",
          "ref": "#value",
          "description": "X offset (0-1 relative to canvas)"
        },
        "y": {
          "type": "ref",
          "ref": "#value",
          "description": "Y offset (0-1 relative to canvas)"
        },
        "scale": {
          "type": "ref",
          "ref": "#value",
          "description": "Uniform scale (0-1, where 1 = 100%)"
        },
        "rotation": {
          "type": "ref",
          "ref": "#value",
          "description": "Rotation (0-1, where 1 = 360 degrees)"
        },
        "anchorX": {
          "type": "ref",
          "ref": "#value",
          "description": "Transform anchor X (0-1)"
        },
        "anchorY": {
          "type": "ref",
          "ref": "#value",
          "description": "Transform anchor Y (0-1)"
        }
      }
    },

    "visualEffect.opacity": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": { "type": "string", "const": "visual.opacity" },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "value": {
          "type": "ref",
          "ref": "#value",
          "description": "Opacity (0-1)"
        },
        "blendMode": {
          "type": "string",
          "enum": ["normal", "multiply", "screen", "overlay", "add"],
          "default": "normal"
        }
      }
    },

    "visualEffect.custom": {
      "type": "object",
      "description": "Custom or third-party visual effect",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Custom effect identifier (e.g., 'visual.vendor.effectName')"
        },
        "enabled": { "type": "ref", "ref": "#booleanValue" },
        "params": {
          "type": "object",
          "description": "Effect-specific parameters"
        }
      }
    },

    "layout": {
      "type": "union",
      "description": "Layout algorithm for positioning group members",
      "refs": [
        "#layout.grid",
        "#layout.absolute",
        "#layout.custom"
      ]
    },

    "layout.grid": {
      "type": "object",
      "description": "Arrange group members in a grid",
      "required": ["type", "columns", "rows"],
      "properties": {
        "type": { "type": "string", "const": "grid" },
        "columns": {
          "type": "integer",
          "minimum": 1,
          "maximum": 16
        },
        "rows": {
          "type": "integer",
          "minimum": 1,
          "maximum": 16
        },
        "gap": {
          "type": "ref",
          "ref": "#value",
          "description": "Gap between cells (0-1 relative)"
        },
        "padding": {
          "type": "ref",
          "ref": "#value",
          "description": "Padding around grid (0-1 relative)"
        },
        "autoPlace": {
          "type": "boolean",
          "description": "Auto-place members without explicit positions",
          "default": true
        }
      }
    },

    "layout.absolute": {
      "type": "object",
      "description": "Position group members using absolute coordinates from member hints",
      "required": ["type"],
      "properties": {
        "type": { "type": "string", "const": "absolute" }
      }
    },

    "layout.custom": {
      "type": "object",
      "description": "Custom or third-party layout",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Custom layout identifier (e.g., 'vendor.layoutName')"
        },
        "params": {
          "type": "object",
          "description": "Layout-specific parameters"
        }
      }
    }
  }
}
